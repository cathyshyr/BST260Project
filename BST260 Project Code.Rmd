---
title: "BST260 Final Project"
author: "Conor Foley, Benjamin Hong, Cathy Wang"
date: "12/4/2017"
output: html_document
---

```{r Load packages, echo = FALSE, message = FALSE, warning = FALSE}
library(XML)
library(RCurl)
library(rlist)
library(readr)
library(tidyverse)
library(dplyr)
library(broom)
library(Lahman)


RMSE <- function(Truth_ratings, predicted_ratings){
    sqrt(mean((Truth_ratings - predicted_ratings)^2, na.rm = TRUE))
  }

```

### Overview and Motivation
Sabermetrics has become quite popular, especially in more recent years. Researchers have developed metrics that are widely used to gauge player performance. The search for more reliable and accurate measures is still ongoing. We will begin our search by analyzing and comparing an increasingly popular but not officially recognized metric: *wins above replacement* (WAR). There is no universal way of calculating WAR, so we assess its accuracy across three different sources. In doing so, we also aim to derive a more "comprehensive" metric, perhaps one that is a combination of the three to improve results.

### Related Work

![](https://raw.githubusercontent.com/wangcathy/BST260Project/master/moneyball07.jpg)

Sabermetrics has a polarizing reputation in the outside world. It is not often regarded as "serious" in academia, and until more recent years, its value was understated and overlooked by individuals of the baseball world. However, the tides began to turn when Michael Lewis punished "Moneyball" in 2003, which focuses on the analytical and sabermetric approach to assembling a competitive baseball team.

In the critically acclaimed movie of the same name, Peter, portrayed by Jonah Hill, criticizes the traditional view of baseball:

> There is an epidemic failure within the game to understand what's really happening. And it leads people who run major league teams to misjudge their players and mismanage their teams. They're still asking the wrong questions. People who run baseball teams still think in terms of buying players. Sorry to say that. The goal shouldn't be to buy players, what you want to buy is wins. To buy wins, you buy runs.

Our goal is to assess the accuracy of WAR, a non-standardized statistic, and provide some insight on its potential value in sabermetrics. 

### Initial Questions

Some initial questions we wish to answer include:
- What is the relationship between WAR and the number of wins a team sees?
- How accurately does WAR predict the number of wins a team observes in a given year?
- How can the three different ways to calculate WAR be combined to produce a more reliable statistic?
- What are some efficient techniques that one could use to scrape data from Fangraphs, Baseball Prospectus, and Baseball Reference, all of which are commonly visited websites in the baseball world?

### Data
Data are obtained from the `Teams` dataset in the `Lahman` package and from three external sources: [Baseball Prospectus](http://legacy.baseballprospectus.com/sortable/), [Baseball Reference](https://www.baseball-reference.com/), and [Fangraphs](https://www.baseball-reference.com/). We scraped data from the three sources using various techniques that are described below. Extensive cleaning had to be done to arrive at a complete and usable dataset.

**Baseball Prospectus**

To calculate `WARP`, [Baseball Prospectus](http://legacy.baseballprospectus.com/sortable/.) uses three proprietary statistics: Batting Runs Above Replacement (BRAR), Fielding Runs Above Replacement (FRAR), and Pitching Runs Above Replacement (PRAR).

The three numbers are added and divided by the number of runs per win that season, which is another proprietary number. According to [Baseball Reference](https://www.baseball-reference.com/bullpen/Wins_Above_Replacement_Player.), this number is around 10. 

![](https://raw.githubusercontent.com/wangcathy/BST260Project/master/scrape_prospectus.png)


Baseball Prospectus provides player, team, and year-specific WAR statistics. Data (as shown above) are displayed annually from 1871 to 2017 with a drop down menu for user selection. 

To scrape year-specific data, we vectorized over the range of years and used the function `set_values` and `submit_form` to automate the selection process and extracted the table of interest by identifying the corresponding `html_node`. 


```{r Baseball Prospectus, eval = FALSE}
url_batting <- "http://legacy.baseballprospectus.com/sortable/index.php?cid=2022181"
url_pitching <- "http://legacy.baseballprospectus.com/sortable/index.php?cid=1931167"

prospectus <- function(year, url){
  year = as.character(year)
  pgsession <- html_session(url)
  pgform <- html_form(pgsession)[[3]]
  
  #Fill in selection form
  filled_form <-set_values(pgform,
                           "year" = year
  )
  
  #Submit selection form
  d <- submit_form(session = pgsession, form = filled_form)
  dat <- d %>%
    html_nodes("table") %>%
    .[[5]] %>%
    html_table(header = Truth)
  dat
}

#Submit Year = X for X in [1871, 2017] to obtain year-specific data
prospectus_batting <- do.call(rbind, lapply(1871:2017, prospectus, url = url_batting))
prospectus_pitching <- do.call(rbind, lapply(1871:2017, prospectus, url = url_pitching))

#Reformat data 
prospectus_pitching <- read.csv("prospectus_pitching_full.csv")
prospectus_batting <- read.csv("prospectus_batting_full.csv")

prospectus_pitching_small <- prospectus_pitching[, c("NAME", "TEAM", "YEAR", "PWARP")]
names(prospectus_pitching_small) <- c("Name", "Team", "Year", "WARP")
prospectus_batting_small <- prospectus_batting[, c("NAME", "TEAM", "YEAR", "BWARP")]
names(prospectus_batting_small) <- c("Name", "Team", "Year", "WARP")
```

**Baseball Reference**

[Baseball Reference](https://www.baseball-reference.com/teams/) defines `rWAR` as

$$
rWAR = (\mbox{Player_Runs - AvgPlayer_Runs) + (AvgPlayer_runs - ReplacePlayer_runs})
$$

`rWAR` is based on six different components: (1) batting runs, (2) baserunning runs, (3) runs added or lost due to grounding into double plays in double play situations, (4) fielding runs,  (5) positional adjustment runs, and (6) replacement level runs. The first five components are compared against the league average, meaning an "average" league player is assigned a value of zero. It follows that negative numbers correspond to worse than average and positive numbers better than average. These five components make up the first half of the equation. The last component, replacement level runs, makes up the second part of the equation.

Data are provided for each team in different years. Separate tables are displayed for batters and pitchers. The screenshot above provides an example of one of the tables shown for the New York Yankees in 2017. 

![](https://raw.githubusercontent.com/wangcathy/BST260Project/master/baseballref_screencap.png)

Links to these tables follow a general pattern, so a vector of all the possible links was created. We then looped through all of these links to grab the tables from each page. Final touches were made to get the datasets into the right format.

```{r Baseball Reference, eval = FALSE}
teams <- unique(Teams$franchID)
years <- 1871:2017

urls <- matrix(0, length(teams), length(years))
for(i in 1:length(teams)) {
  for(j in 1:length(years)) {
    urls[i, j] <- paste0("https://www.baseball-reference.com/teams/", teams[i], "/", years[j], ".shtml")
  }
}
url_vector <- as.vector(urls)

list_of_batting <- list()
list_of_pitching <- list()
for(i in 1:5000) {
  url <- url_vector[i]
  
  res <- try(readLines(url), silent = TRUE)
  
  ## check if website exists
  if(inherits(res, "try-error")) {
    list_of_batting[[i]] <- NA
    list_of_pitching[[i]] <- NA
  }
  else {
    urltxt <- readLines(url)
    urltxt <- gsub("-->", "", gsub("<!--", "", urltxt))
    doc <- htmlParse(urltxt)
    tables_full <- readHTMLTable(doc)
    tmp1 <- tables_full$players_value_batting
    tmp2 <- tables_full$players_value_pitching
    list_of_batting[[i]] <- tmp1
    list_of_pitching[[i]] <- tmp2
  }
  print(i)
  closeAllConnections()
}

for(i in 5001:10000) {
  url <- url_vector[i]
  
  res <- try(readLines(url), silent = TRUE)
  
  ## check if website exists
  if(inherits(res, "try-error")) {
    list_of_batting[[i]] <- NA
    list_of_pitching[[i]] <- NA
  }
  else {
    urltxt <- readLines(url)
    urltxt <- gsub("-->", "", gsub("<!--", "", urltxt))
    doc <- htmlParse(urltxt)
    tables_full <- readHTMLTable(doc)
    tmp1 <- tables_full$players_value_batting
    tmp2 <- tables_full$players_value_pitching
    list_of_batting[[i]] <- tmp1
    list_of_pitching[[i]] <- tmp2
  }
  print(i)
  closeAllConnections()
}

for(i in 10001:17640) {
  url <- url_vector[i]
  
  res <- try(readLines(url), silent = TRUE)
  
  ## check if website exists
  if(inherits(res, "try-error")) {
    list_of_batting[[i]] <- NA
    list_of_pitching[[i]] <- NA
  }
  else {
    urltxt <- readLines(url)
    urltxt <- gsub("-->", "", gsub("<!--", "", urltxt))
    doc <- htmlParse(urltxt)
    tables_full <- readHTMLTable(doc)
    tmp1 <- tables_full$players_value_batting
    tmp2 <- tables_full$players_value_pitching
    list_of_batting[[i]] <- tmp1
    list_of_pitching[[i]] <- tmp2
  }
  print(i)
  closeAllConnections()
}

## find indices where the link exists
ind_batting <- which(!is.na(list_of_batting))
ind_pitching <- which(!is.na(list_of_pitching))

## find links that exist
url_batting <- url_vector[ind_batting]
url_pitching <- url_vector[ind_pitching]

## extract year from each url
years_batting <- as.numeric(unlist(regmatches(url_batting, gregexpr("[[:digit:]]+", url_batting))))
years_pitching <- as.numeric(unlist(regmatches(url_pitching, gregexpr("[[:digit:]]+", url_pitching))))

## extract team from each url
teams_batting <- basename(dirname(url_batting))
teams_pitching <- basename(dirname(url_pitching))

## remove NAs from lists
na.omit.list <- function(y) { 
  return(y[!sapply(y, function(x) all(is.na(x)))]) 
}

test_batting <- na.omit.list(list_of_batting)
test_pitching <- na.omit.list(list_of_pitching)

## add columns for year and team
test_batting <- mapply(cbind, test_batting, "Year" = years_batting, 
                       "Team" = teams_batting, SIMPLIFY = F)
test_pitching <- mapply(cbind, test_pitching, "Year" = years_pitching,
                        "Team" = teams_pitching, SIMPLIFY = F)

bbref_batting <- bind_rows(test_batting)
bbref_pitching <- bind_rows(test_pitching)
```

```{r, eval = FALSE, echo = FALSE}
# prospectus_pitching <- read_csv("prospectus_batting_full.csv")
# head(prospectus_pitching_small)
prospectus <- rbind(prospectus_pitching_small, prospectus_batting_small)
#prospectus$X <- NULL

#Calculate year and team specific WAR
prospectus_team <- prospectus %>% 
  group_by(Team, Year) %>%
  summarise(WARP = sum(WARP)) %>%
  rename(franchID = Team, yearID = Year)

team_sub <- Teams %>%
  select(yearID, franchID, W) 

prospectus_merge <- left_join(prospectus_team, team_sub, by = c("franchID", "yearID"))

#Save dataset 
write.csv(prospectus_merge, file = "prospectus.csv")
```


### Exploratory Analysis
What visualizations did you use to look at your data in different ways? What are the different statistical methods you considered? Justify the decisions you made, and show any major changes to your ideas. How did you reach these conclusions?

####Combine data sets

```{r, warning = FALSE, message = FALSE}
#Read in BBProspectus data and remove extraneous columns
BBProspectus <- read.csv("prospectus.csv")
BBProspectus <- BBProspectus %>%
    rename(BBproWAR = WARP, teamID = franchID) %>%
    select(c(-X, -W))

#Baseball Prospectus had some funny names, so first we need to align them with our other datasets using Lahman
BBProspectus$franchID = NA

BBProspectus = BBProspectus %>%
    filter(yearID >= 1903)

for (i in 1:length(BBProspectus[, 1]))
{

    BBProspectus[i, ]$franchID = 
        as.character(unique(
            Teams$franchID[as.character(Teams$teamID) == as.character(BBProspectus[i, ]$teamID)])[1])
}    

BBProspectus = BBProspectus %>%
    select(c(-teamID))

#Read in BBProspectus data and remove extraneous columns
BBReference <- read.csv("BBReference.csv")
BBReference <- BBReference %>%
  rename(BRefWAR = WAR) %>%
  select(c(-X, -source, -W))

FanGraphs <- read.csv("Conor/FanGraphWARs_better_format.csv")
FanGraphs <- FanGraphs %>%
    rename(FanGraphWAR = WAR, yearID=year) %>%
    select(c(-X))


#Inner join the three for a complete data set
data <- inner_join(BBReference, BBProspectus, by = c("franchID", "yearID"))
data = inner_join(data, FanGraphs, by =c("franchID", "yearID"))

#Join combined data with true number of wins in Lahman's dataset to create wide data set 
team_sub <- Teams %>%
  select(yearID, franchID, W, G)  %>%
  rename(Truth = W, Games = G)
data_wide <- left_join(data, team_sub, by = c("franchID", "yearID"))

data_wide = data_wide %>%
    mutate(BRefWAR = BRefWAR + Games/3, FanGraphWAR = FanGraphWAR + Games * 0.294) %>%
    rename(BRefPred = BRefWAR, FanGraphPred = FanGraphWAR)#Do BBProspectus separately because of 0's

data_wide = data_wide %>%
    filter(BBproWAR != 0) %>%
    mutate(BBproWAR = BBproWAR + Games/3) %>%
    rename(BBproPred = BBproWAR)

#Gather into long data format
data_long <- gather(data_wide, source, WAR, -c(franchID, yearID)) ##TODO do we need this? -Conor

```


####How well does WAR compare to the true number of wins?

```{r, warning = FALSE, message = FALSE, fig.width=10, fig.align='center'}

RMSE(data_wide$Truth, data_wide$FanGraphPred)
RMSE(data_wide$Truth[data_wide$yearID >= 1949], data_wide$BBproPred[data_wide$yearID >= 1949]) #only have data for these years


FG_diff = data_wide$FanGraphPred - data_wide$Truth
mean(FG_diff)
median(FG_diff)
sd(FG_diff)

BBP_diff = data_wide$BBproPred[data_wide$yearID >= 1949] - data_wide$Truth[data_wide$yearID >= 1949]
mean(BBP_diff)
median(BBP_diff)
sd(BBP_diff)

#TODO make these ggplot, keep dim the same across graphs (or do overlapping graphs)
hist(FG_diff)
hist(BBP_diff)  

data_wide %>% ggplot(aes(x = Truth, y = FanGraphPred)) +  
    geom_point(color="blue", size = 1) +
    geom_abline(slope = 1, intercept = 0) 

lm(Truth ~ FanGraphPred, data = data_wide)

data_sum <- data_long %>%
  group_by(yearID, source) %>%
  summarize(sumWAR = sum(WAR))

data_sum %>%
  ggplot(aes(x = yearID, y = sumWAR, group = source)) + 
  geom_line(aes(color = source)) +
  ggtitle("Number of Wins vs. Wins by Replacement (WAR) by Year") +
  xlab("Year") +
  ylab("Number of Wins")
```

From this plot, it appears that both `rWAR` and `WARP` capture the trend of true wins over time. However, there is a substantial bias because both WAR statistics are hugely underestimating the truth. 

Next, let's build a naive model to capture the effect of WAR on predicting the truth for each of the 3 WAR statistics. 

```{r, warning = FALSE, message = FALSE, fig.width=10, fig.align='center'}
#Linear regression for rWAR and WARP, respectively
m1 <- lm(Truth ~ rWAR, data = data_wide)
m2 <- lm(Truth ~ WARP, data = data_wide)

#Make predictions based on model fit
pred <- predict(m1, newdata = data_wide)
pred2 <- predict(m2, newdata = data_wide)

#Wrangle data for plotting
df_predRef <- cbind(data_wide, rWARpred = pred)
a2 <- df_predRef %>%
  group_by(yearID) %>%
  summarize(sum.rWARpred = sum(rWARpred))

df_predPros <- cbind(data_wide, WARPpred = pred2)
a3 <- df_predPros %>%
  group_by(yearID) %>%
  summarize(sum.WARPpred = sum(WARPpred))

p <- ggplot() + 
  geom_line(data = data_sum[data_sum$source == "Truth", ], aes(x = yearID, y = sumWAR, group = source, color = source)) +
  geom_line(data = a2, aes(x = yearID, y = sum.rWARpred, color = "rWAR Pred")) + 
  geom_line(data = a3, aes(x = yearID, y = sum.WARPpred, color = "WARP Pred")) + 
  ggtitle("Number of Wins vs. Fitted Values from Naive Model by Year") +
  xlab("Year") +
  ylab("Number of Wins")
p


a <- data_wide %>%
  group_by(yearID) %>%
  summarize(sumW = sum(Truth))

RMSE(a$sumW, a2$sum.rWARpred)
RMSE(a$sumW, a3$sum.WARPpred)
```

According to RMSE, `rWAR` is a better predictor than `WARP`. However, we can definitely improve upon the naive model by accounting for the substructure within our data, e.g. team effect, team x year interaction effect, etc. 

### Final Analysis
What did you learn about the data? How did you answer the questions? How can you justify your answers?

