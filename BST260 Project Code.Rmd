---
title: "BST260 Final Project"
author: "Conor Foley, Benjamin Hong, Cathy Wang"
date: "12/4/2017"
output: html_document
---

```{r Load packages, echo = FALSE, message = FALSE, warning = FALSE}
library(XML)
library(RCurl)
library(rlist)
library(readr)
library(tidyverse)
library(dplyr)
library(broom)
library(Lahman)


RMSE <- function(Truth_ratings, predicted_ratings){
    sqrt(mean((Truth_ratings - predicted_ratings)^2, na.rm = TRUE))
  }

```

### Overview and Motivation
Provide an overview of the project goals and the motivation for it. Consider that this will be read by people who did not see your project proposal.

### Related Work
Anything that inspired you, such as a paper, a web site, or something we discussed in class.



### Initial Questions
What questions are you trying to answer? How did these questions evolve over the course of the project? What new questions did you consider in the course of your analysis?

### Data
Source, scraping method, cleanup, etc.
**Baseball Prospectus**
**Baseball Reference**


**Baseball Prospectus**

To calculate WARP, [Baseball Prospectus](http://legacy.baseballprospectus.com/sortable/.) uses three proprietary statistics: Batting Runs Above Replacement (BRAR), Fielding Runs Above Replacement (FRAR), and Pitching Runs Above Replacement (PRAR).

The three numbers are added and divided by the number of runs per win that season, which is another proprietary number. According to [Baseball Reference](https://www.baseball-reference.com/bullpen/Wins_Above_Replacement_Player.), this number is around 10. 



```{r Baseball Prospectus, eval = FALSE}
url_batting <- "http://legacy.baseballprospectus.com/sortable/index.php?cid=2022181"
url_pitching <- "http://legacy.baseballprospectus.com/sortable/index.php?cid=1931167"

prospectus <- function(year, url){
  year = as.character(year)
  pgsession <- html_session(url)
  pgform <- html_form(pgsession)[[3]]
  
  #Fill in selection form
  filled_form <-set_values(pgform,
                           "year" = year
  )
  
  #Submit selection form
  d <- submit_form(session = pgsession, form = filled_form)
  dat <- d %>%
    html_nodes("table") %>%
    .[[5]] %>%
    html_table(header = Truth)
  dat
}

#Submit Year = X for X in [1871, 2017] to obtain year-specific data
prospectus_batting <- do.call(rbind, lapply(1871:2017, prospectus, url = url_batting))
prospectus_pitching <- do.call(rbind, lapply(1871:2017, prospectus, url = url_pitching))

#Reformat data 
prospectus_pitching <- read.csv("prospectus_pitching_full.csv")
prospectus_batting <- read.csv("prospectus_batting_full.csv")

prospectus_pitching_small <- prospectus_pitching[, c("NAME", "TEAM", "YEAR", "PWARP")]
names(prospectus_pitching_small) <- c("Name", "Team", "Year", "WARP")
prospectus_batting_small <- prospectus_batting[, c("NAME", "TEAM", "YEAR", "BWARP")]
names(prospectus_batting_small) <- c("Name", "Team", "Year", "WARP")
```

```{r, eval = FALSE}
# prospectus_pitching <- read_csv("prospectus_batting_full.csv")
# head(prospectus_pitching_small)
prospectus <- rbind(prospectus_pitching_small, prospectus_batting_small)
head(prospectus)
#prospectus$X <- NULL

#Calculate year and team specific WAR
prospectus_team <- prospectus %>% 
  group_by(Team, Year) %>%
  summarise(WARP = sum(WARP)) %>%
  rename(franchID = Team, yearID = Year)

team_sub <- Teams %>%
  select(yearID, franchID, W) 

prospectus_merge <- left_join(prospectus_team, team_sub, by = c("franchID", "yearID"))

#Save dataset 
write.csv(prospectus_merge, file = "prospectus.csv")
```


### Exploratory Analysis
What visualizations did you use to look at your data in different ways? What are the different statistical methods you considered? Justify the decisions you made, and show any major changes to your ideas. How did you reach these conclusions?

#Combine data sets

```{r, warning = FALSE, message = FALSE}
#Read in BBProspectus data and remove extraneous columns
BBProspectus <- read.csv("prospectus.csv")
BBProspectus <- BBProspectus %>%
  select(c(-X, -W))
names(BBProspectus)

#Read in BBProspectus data and remove extraneous columns
BBReference <- read.csv("BBReference.csv")
BBReference <- BBReference %>%
  rename(rWAR = WAR) %>%
  select(c(-X, -source, -W))


#Inner join BB Ref and BB Pros for a complete data set
data <- inner_join(BBReference, BBProspectus, by = c("franchID", "yearID"))

#Join combined data with true number of wins in Lahman's dataset to create wide data set 
team_sub <- Teams %>%
  select(yearID, franchID, W)  %>%
  rename(Truth = W)
data_wide <- left_join(data, team_sub, by = c("franchID", "yearID"))

#Gather into long data format
data_long <- gather(data_wide, source, WAR, -c(franchID, yearID))
```


#How well does WAR compare to the true number of wins?

```{r, warning = FALSE}
data_sum <- data_long %>%
  group_by(yearID, source) %>%
  summarize(sumWAR = sum(WAR))

data_sum %>%
  ggplot(aes(x = yearID, y = sumWAR, group = source)) + 
  geom_line(aes(color = source))
```

From this plot, it appears that both rWAR and WARP capture the trend of true wins over time. However, there is a substantial bias because both WAR statistics are hugely underestimating the truth. 

Next, let's build a naive model to capture the effect of WAR on predicting the truth for each of the 3 WAR statistics. 

```{r, warning = FALSE, message = FALSE}
#Linear regression for rWAR and WARP, respectively
m1 <- lm(Truth ~ rWAR, data = data_wide)
m2 <- lm(Truth ~ WARP, data = data_wide)

#Make predictions based on model fit
pred <- predict(m1, newdata = data_wide)
pred2 <- predict(m2, newdata = data_wide)

#Wrangle data for plotting
df_predRef <- cbind(data_wide, rWARpred = pred)
a2 <- df_predRef %>%
  group_by(yearID) %>%
  summarize(sum.rWARpred = sum(rWARpred))

df_predPros <- cbind(data_wide, WARPpred = pred2)
a3 <- df_predPros %>%
  group_by(yearID) %>%
  summarize(sum.WARPpred = sum(WARPpred))

p <- ggplot() + 
  geom_line(data = data_sum, aes(x = yearID, y = sumWAR, group = source, color = source)) +
  geom_line(data = a2, aes(x = yearID, y = sum.rWARpred, color = "BB Ref Pred")) + 
  geom_line(data = a3, aes(x = yearID, y = sum.WARPpred, color = "BB Pros Pred"))
p

a <- data_wide %>%
  group_by(yearID) %>%
  summarize(sumW = sum(Truth))

RMSE(a$sumW, a2$sum.rWARpred)
RMSE(a$sumW, a3$sum.WARPpred)
```

According to RMSE, `rWAR` is a better predictor of `WARP`. However, we can definitely improve upon the naive model, since we did not account for the substructure within our data, e.g. team effect, team x year interaction effect, etc. 

### Final Analysis
What did you learn about the data? How did you answer the questions? How can you justify your answers?

